<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz</title>
    <link rel="stylesheet" href="../style/styles.css">
</head>
<body>
    <div class="app-container">
        <nav class="nav-bar">
            <span class="nav-header">Teacher Portal</span>
            <div class="nav-links">
                <a href="professor_quizzes.html" class="nav-item active">
                    <span class="nav-icon">üìù</span> <span>Quizzes</span>
                </a>
                <a href="professor_classes.html" class="nav-item">
                    <span class="nav-icon">üè´</span> <span>Classes</span>
                </a>
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">üö™</span> <span>Logout</span>
                </a>
            </div>
        </nav>

        <main class="main-content">
            <div class="mobile-header">New Quiz</div>

            <div class="card">
                <h3>Create New Quiz</h3>
                
                <label>Quiz Name</label>
                <input type="text" id="quizName" placeholder="e.g. Midterm ASD">

                <label>Number of Questions</label>
                <div class="flex-row">
                    <input type="number" id="qCount" value="20" min="1" max="100" style="width: 80px;" onchange="updateAnswerRows()">
                    <span class="text-small" style="color: #4ecdc4; cursor: pointer;" onclick="updateAnswerRows()">Update</span>
                </div>

                <label>Number of Answer Options</label>
                <select id="answerOptions" onchange="updateAnswerRows()" style="width: 100px;">
                    <option value="2">2 (A, B)</option>
                    <option value="3">3 (A, B, C)</option>
                    <option value="4" selected>4 (A, B, C, D)</option>
                    <option value="5">5 (A, B, C, D, E)</option>
                </select>

                <label>Default Points per Question</label>
                <input type="number" id="defaultPoints" value="1" min="0.1" step="0.1" style="width: 100px;" onchange="updateAnswerRows()">
                <p class="text-small" style="color: #666; margin-top: 5px;">You can customize points for each question below. This value will be used as default for all questions.</p>

                <h4 style="margin: 20px 0 10px;">Answer Key & Points <span style="font-size: 12px; color: #666; font-weight: normal;">(Select correct answers and set points per question)</span></h4>
                
                <div id="answers-rows" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                    <!-- Answer rows will be generated dynamically -->
                </div>

                <h4 style="margin: 30px 0 10px;">Justification PDF <span style="font-size: 12px; color: #666; font-weight: normal;">(Optional)</span></h4>
                <div style="padding: 15px; background: #f9f9f9; border-radius: 5px; border: 2px dashed #ddd;">
                    <input type="file" id="justificationPDF" accept=".pdf" style="margin-bottom: 10px;" onchange="handlePDFSelect(event)">
                    <div id="pdfPreview" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong id="pdfFileName" style="color: #4ecdc4;"></strong>
                                <div class="text-small" id="pdfFileSize"></div>
                            </div>
                            <button type="button" onclick="removePDF()" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Remove</button>
                        </div>
                    </div>
                    <p class="text-small" style="color: #666; margin-top: 10px;">
                        Upload a PDF file containing the justification/explanation for all questions in this quiz.
                    </p>
                </div>

                <button class="primary-btn" onclick="handleCreate()">SAVE QUIZ</button>
                <button class="secondary-btn" style="width:100%; margin-top:10px; border:none;" onclick="history.back()">Cancel</button>
            </div>
        </main>
    </div>

    <script src="../js/script.js"></script>
    <script>
        // Initialize answer rows on page load
        window.addEventListener('DOMContentLoaded', function() {
            updateAnswerRows();
        });

        function updateAnswerRows() {
            const qCount = parseInt(document.getElementById('qCount').value) || 20;
            const optionCount = parseInt(document.getElementById('answerOptions').value) || 4;
            const container = document.getElementById('answers-rows');
            
            if (qCount < 1 || qCount > 100) {
                alert('Number of questions must be between 1 and 100');
                return;
            }

            const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const availableLetters = letters.slice(0, optionCount);
            
            const defaultPoints = parseFloat(document.getElementById('defaultPoints').value) || 1;
            
            let html = '';
            for (let i = 1; i <= qCount; i++) {
                const checkboxes = availableLetters.map(letter => 
                    `<label style="display: inline-flex; align-items: center; margin: 0 8px; cursor: pointer;">
                        <input type="checkbox" class="answer-checkbox" data-question="${i}" value="${letter}" style="margin-right: 5px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">${letter}</span>
                    </label>`
                ).join('');
                
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <strong style="min-width: 30px;">${i}.</strong>
                            <div style="display: flex; flex-wrap: wrap; flex: 1;">
                                ${checkboxes}
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px; margin-left: auto;">
                                <label style="font-size: 12px; color: #666;">Points:</label>
                                <input type="number" class="question-points" data-question="${i}" value="${defaultPoints}" min="0.1" step="0.1" style="width: 60px; padding: 4px; font-size: 12px;">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        let selectedPDF = null;

        function handlePDFSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type !== 'application/pdf') {
                    alert('Please select a PDF file.');
                    event.target.value = '';
                    return;
                }
                
                selectedPDF = file;
                document.getElementById('pdfFileName').textContent = file.name;
                document.getElementById('pdfFileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
                document.getElementById('pdfPreview').style.display = 'block';
            }
        }

        function removePDF() {
            selectedPDF = null;
            document.getElementById('justificationPDF').value = '';
            document.getElementById('pdfPreview').style.display = 'none';
        }

        function handleCreate() {
            const name = document.getElementById('quizName').value;
            const count = parseInt(document.getElementById('qCount').value) || 20;
            
            if(!name) { 
                alert('Please enter a quiz name'); 
                return; 
            }

            if (count < 1 || count > 100) {
                alert('Number of questions must be between 1 and 100');
                return;
            }

            // Collect all answer keys (can be arrays for multiple answers)
            const answerKeys = {};
            const questionPoints = {};
            const checkboxes = document.querySelectorAll('.answer-checkbox');
            
            checkboxes.forEach(checkbox => {
                const questionNum = checkbox.getAttribute('data-question');
                if (!answerKeys[questionNum]) {
                    answerKeys[questionNum] = [];
                }
                if (checkbox.checked) {
                    answerKeys[questionNum].push(checkbox.value);
                }
            });
            
            // Collect points for each question
            const pointInputs = document.querySelectorAll('.question-points');
            pointInputs.forEach(input => {
                const questionNum = input.getAttribute('data-question');
                const points = parseFloat(input.value) || 1;
                if (points <= 0) {
                    alert(`Points for question ${questionNum} must be greater than 0`);
                    return;
                }
                questionPoints[questionNum] = points;
            });
            
            // Validate that each question has at least one answer
            for (let i = 1; i <= count; i++) {
                if (!answerKeys[i] || answerKeys[i].length === 0) {
                    alert(`Please select at least one correct answer for question ${i}`);
                    return;
                }
                if (!questionPoints[i] || questionPoints[i] <= 0) {
                    alert(`Please set valid points for question ${i}`);
                    return;
                }
            }

            // Get number of answer options
            const answerOptions = parseInt(document.getElementById('answerOptions').value) || 4;

            // Handle PDF file
            let justificationPDF = null;
            if (selectedPDF) {
                // Convert PDF to base64 for storage (or you can store just the file name/path)
                const reader = new FileReader();
                reader.onload = function(e) {
                    justificationPDF = {
                        name: selectedPDF.name,
                        size: selectedPDF.size,
                        type: selectedPDF.type,
                        data: e.target.result // base64 encoded file
                    };
                    
                    createQuiz(name, count, answerKeys, justificationPDF, questionPoints, answerOptions);
                    alert('Quiz Created!');
                    window.location.href = 'professor_quizzes.html';
                };
                reader.readAsDataURL(selectedPDF);
            } else {
                createQuiz(name, count, answerKeys, null, questionPoints, answerOptions);
                alert('Quiz Created!');
                window.location.href = 'professor_quizzes.html';
            }
        }
    </script>
</body>
</html>